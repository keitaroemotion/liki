#!/usr/bin/env python
import os
import sys
from os import listdir

wiki_dir = "/usr/local/etc/liki/pages"

def makeDirs(directory):
    if(not os.path.exists(directory)):
        os.makedirs(directory)
    return directory

def addChild(node, term):
    return (node + "/{0}").format(term)

def getDirectory(rootdir, folder):
    return makeDirs(addChild(rootdir, folder))  

def getPage(term):
    return addChild(getDirectory(wiki_dir, term[0]), term)

def writeToFile(page, text, mode="a"):
    f = open(page, mode)
    f.write(text + "\n")
    f.close

def makeText(text, addition, message=""):
    sys.stdout.write(message)
    return text if (addition == "fin") else makeText(text + addition + "\n", raw_input())

# look for page file
def findPage(keyword=""):
    if(keyword == ""):
      sys.stdout.write("[find] word: ")
      keyword = raw_input()

    result_list = [f for f in listdir(getDirectory(wiki_dir, keyword[0])) if f.startswith(keyword)]

    {
        True  : (lambda x : showPage(x[0])),
        False : (lambda x : findPage())
    }[len(result_list) == 1](result_list)

def showPage(page):
    f = open(getPage(page), "r")
    print(f.read())

# create page file
def createPage():
    sys.stdout.write("[create] word: ")
    page = getPage(raw_input())
    writeToFile(page, makeText("", "", "text[type fin at EOF]: \n"))
      
# edit page file

# link page file

# list pages with key

# grep pages

#
# here is the main execution part.
#
# if argument does not exist, show help message
if(len(sys.argv) < 2):
  print("you need argument")  
  print("")  
  print("[find]   : find page")  
  print("[create] : create page\n")  

  sys.exit()   

# dispatch execution function
{
  "find"   : findPage,
  "create" : createPage
}[sys.argv[1]]()

